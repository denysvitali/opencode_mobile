name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

# Concurrency: Cancel in-progress runs for the same branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Job 1: Code Analysis (Fast feedback)
  # ============================================
  analyze:
    name: Analyze Code
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Cache Pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/.dart_tool
          key: pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-

      - name: Get dependencies
        run: flutter pub get

      - name: Analyze code
        run: flutter analyze --no-fatal-infos || true

  # ============================================
  # Job 2: Unit Tests (Fast feedback)
  # ============================================
  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Cache Pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/.dart_tool
          key: pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-

      - name: Get dependencies
        run: flutter pub get

      - name: Run unit tests
        run: flutter test --no-pub test/ || echo "No unit tests found or tests failed"

  # ============================================
  # Job 3: Build Test Infrastructure
  # ============================================
  build-opencode:
    name: Build OpenCode
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout opencode repository
        uses: actions/checkout@v4
        with:
          repository: anomalyco/opencode
          path: opencode

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            opencode/node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('opencode/**/bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Cache opencode build
        uses: actions/cache@v4
        with:
          path: opencode/packages/opencode/dist
          key: opencode-build-${{ hashFiles('opencode/**/*.ts') }}

      - name: Install dependencies
        working-directory: opencode/packages/opencode
        run: bun install

      - name: Build opencode
        working-directory: opencode/packages/opencode
        run: bun run build

  # ============================================
  # Job 4a: Session Management Tests
  # ============================================
  test-session-management:
    name: Test - Session Management
    runs-on: ubuntu-latest
    needs: [build-opencode, analyze]
    timeout-minutes: 15
    continue-on-error: true

    steps:
      - name: Checkout mobile repository
        uses: actions/checkout@v4

      - name: Checkout opencode repository
        uses: actions/checkout@v4
        with:
          repository: anomalyco/opencode
          path: opencode

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Cache Pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/.dart_tool
          key: pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            opencode/node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('opencode/**/bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Cache opencode build
        uses: actions/cache@v4
        with:
          path: opencode/packages/opencode/dist
          key: opencode-build-${{ hashFiles('opencode/**/*.ts') }}

      - name: Install Bun dependencies if needed
        working-directory: opencode/packages/opencode
        run: |
          if [ ! -d "node_modules" ] || [ -z "$(ls -A node_modules 2>/dev/null)" ]; then
            echo "Installing Bun dependencies..."
            bun install
          fi

      - name: Build opencode if needed
        working-directory: opencode/packages/opencode
        run: |
          if [ ! -d "dist" ] || [ -z "$(ls -A dist 2>/dev/null)" ]; then
            echo "Building opencode..."
            bun run build
          fi

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Start servers and run tests
        run: |
          # Start Mock LLM
          bun run test/mock_llm_server.ts &
          MOCK_PID=$!
          
          # Wait for mock
          for i in {1..30}; do
            if curl -s http://localhost:4097/health > /dev/null 2>&1; then
              echo "✓ Mock server ready"
              break
            fi
            sleep 1
          done
          
          # Start OpenCode
          export OPENCODE_CONFIG=$(pwd)/test/opencode.test.yaml
          bun run opencode/packages/opencode/src/cli/cmd/serve.ts &
          SERVER_PID=$!
          
          # Wait for opencode
          for i in {1..30}; do
            if curl -s http://localhost:4096/global/health > /dev/null 2>&1; then
              echo "✓ OpenCode server ready"
              break
            fi
            sleep 1
          done
          
          # Run tests
          flutter test integration_test/session_management_test.dart \
            --dart-define=SERVER_URL=http://localhost:4096 || TEST_EXIT=$?
          
          # Cleanup
          kill $MOCK_PID $SERVER_PID 2>/dev/null || true
          
          exit ${TEST_EXIT:-0}

  # ============================================
  # Job 4b: Config & Auth Tests
  # ============================================
  test-config-auth:
    name: Test - Config & Auth
    runs-on: ubuntu-latest
    needs: [build-opencode, analyze]
    timeout-minutes: 15
    continue-on-error: true

    steps:
      - name: Checkout mobile repository
        uses: actions/checkout@v4

      - name: Checkout opencode repository
        uses: actions/checkout@v4
        with:
          repository: anomalyco/opencode
          path: opencode

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Cache Pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/.dart_tool
          key: pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            opencode/node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('opencode/**/bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Cache opencode build
        uses: actions/cache@v4
        with:
          path: opencode/packages/opencode/dist
          key: opencode-build-${{ hashFiles('opencode/**/*.ts') }}

      - name: Install Bun dependencies if needed
        working-directory: opencode/packages/opencode
        run: |
          if [ ! -d "node_modules" ] || [ -z "$(ls -A node_modules 2>/dev/null)" ]; then
            echo "Installing Bun dependencies..."
            bun install
          fi

      - name: Build opencode if needed
        working-directory: opencode/packages/opencode
        run: |
          if [ ! -d "dist" ] || [ -z "$(ls -A dist 2>/dev/null)" ]; then
            echo "Building opencode..."
            bun run build
          fi

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Start servers and run tests
        run: |
          bun run test/mock_llm_server.ts &
          MOCK_PID=$!
          for i in {1..30}; do
            curl -s http://localhost:4097/health > /dev/null 2>&1 && break
            sleep 1
          done
          
          export OPENCODE_CONFIG=$(pwd)/test/opencode.test.yaml
          bun run opencode/packages/opencode/src/cli/cmd/serve.ts &
          SERVER_PID=$!
          for i in {1..30}; do
            curl -s http://localhost:4096/global/health > /dev/null 2>&1 && break
            sleep 1
          done
          
          flutter test integration_test/config_auth_test.dart \
            --dart-define=SERVER_URL=http://localhost:4096 || TEST_EXIT=$?
          
          kill $MOCK_PID $SERVER_PID 2>/dev/null || true
          exit ${TEST_EXIT:-0}

  # ============================================
  # Job 4c: SSE Events Tests
  # ============================================
  test-sse-events:
    name: Test - SSE Events
    runs-on: ubuntu-latest
    needs: [build-opencode, analyze]
    timeout-minutes: 15
    continue-on-error: true

    steps:
      - name: Checkout mobile repository
        uses: actions/checkout@v4

      - name: Checkout opencode repository
        uses: actions/checkout@v4
        with:
          repository: anomalyco/opencode
          path: opencode

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Cache Pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/.dart_tool
          key: pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            opencode/node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('opencode/**/bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Cache opencode build
        uses: actions/cache@v4
        with:
          path: opencode/packages/opencode/dist
          key: opencode-build-${{ hashFiles('opencode/**/*.ts') }}

      - name: Install Bun dependencies if needed
        working-directory: opencode/packages/opencode
        run: |
          if [ ! -d "node_modules" ] || [ -z "$(ls -A node_modules 2>/dev/null)" ]; then
            echo "Installing Bun dependencies..."
            bun install
          fi

      - name: Build opencode if needed
        working-directory: opencode/packages/opencode
        run: |
          if [ ! -d "dist" ] || [ -z "$(ls -A dist 2>/dev/null)" ]; then
            echo "Building opencode..."
            bun run build
          fi

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Start servers and run tests
        run: |
          bun run test/mock_llm_server.ts &
          MOCK_PID=$!
          for i in {1..30}; do
            curl -s http://localhost:4097/health > /dev/null 2>&1 && break
            sleep 1
          done
          
          export OPENCODE_CONFIG=$(pwd)/test/opencode.test.yaml
          bun run opencode/packages/opencode/src/cli/cmd/serve.ts &
          SERVER_PID=$!
          for i in {1..30}; do
            curl -s http://localhost:4096/global/health > /dev/null 2>&1 && break
            sleep 1
          done
          
          flutter test integration_test/sse_events_full_test.dart \
            --dart-define=SERVER_URL=http://localhost:4096 || TEST_EXIT=$?
          
          kill $MOCK_PID $SERVER_PID 2>/dev/null || true
          exit ${TEST_EXIT:-0}

  # ============================================
  # Job 4d: Streaming Tests
  # ============================================
  test-streaming:
    name: Test - Streaming
    runs-on: ubuntu-latest
    needs: [build-opencode, analyze]
    timeout-minutes: 15
    continue-on-error: true

    steps:
      - name: Checkout mobile repository
        uses: actions/checkout@v4

      - name: Checkout opencode repository
        uses: actions/checkout@v4
        with:
          repository: anomalyco/opencode
          path: opencode

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Cache Pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/.dart_tool
          key: pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            opencode/node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('opencode/**/bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Cache opencode build
        uses: actions/cache@v4
        with:
          path: opencode/packages/opencode/dist
          key: opencode-build-${{ hashFiles('opencode/**/*.ts') }}

      - name: Install Bun dependencies if needed
        working-directory: opencode/packages/opencode
        run: |
          if [ ! -d "node_modules" ] || [ -z "$(ls -A node_modules 2>/dev/null)" ]; then
            echo "Installing Bun dependencies..."
            bun install
          fi

      - name: Build opencode if needed
        working-directory: opencode/packages/opencode
        run: |
          if [ ! -d "dist" ] || [ -z "$(ls -A dist 2>/dev/null)" ]; then
            echo "Building opencode..."
            bun run build
          fi

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Start servers and run tests
        run: |
          bun run test/mock_llm_server.ts &
          MOCK_PID=$!
          for i in {1..30}; do
            curl -s http://localhost:4097/health > /dev/null 2>&1 && break
            sleep 1
          done
          
          export OPENCODE_CONFIG=$(pwd)/test/opencode.test.yaml
          bun run opencode/packages/opencode/src/cli/cmd/serve.ts &
          SERVER_PID=$!
          for i in {1..30}; do
            curl -s http://localhost:4096/global/health > /dev/null 2>&1 && break
            sleep 1
          done
          
          flutter test integration_test/streaming_message_test.dart \
            --dart-define=SERVER_URL=http://localhost:4096 || TEST_EXIT=$?
          
          kill $MOCK_PID $SERVER_PID 2>/dev/null || true
          exit ${TEST_EXIT:-0}

  # ============================================
  # Job 4e: Existing Integration Tests
  # ============================================
  test-existing:
    name: Test - Existing Integration
    runs-on: ubuntu-latest
    needs: [build-opencode, analyze]
    timeout-minutes: 15
    continue-on-error: true

    steps:
      - name: Checkout mobile repository
        uses: actions/checkout@v4

      - name: Checkout opencode repository
        uses: actions/checkout@v4
        with:
          repository: anomalyco/opencode
          path: opencode

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Cache Pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/.dart_tool
          key: pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: pub-

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            opencode/node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('opencode/**/bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Cache opencode build
        uses: actions/cache@v4
        with:
          path: opencode/packages/opencode/dist
          key: opencode-build-${{ hashFiles('opencode/**/*.ts') }}

      - name: Install Bun dependencies if needed
        working-directory: opencode/packages/opencode
        run: |
          if [ ! -d "node_modules" ] || [ -z "$(ls -A node_modules 2>/dev/null)" ]; then
            echo "Installing Bun dependencies..."
            bun install
          fi

      - name: Build opencode if needed
        working-directory: opencode/packages/opencode
        run: |
          if [ ! -d "dist" ] || [ -z "$(ls -A dist 2>/dev/null)" ]; then
            echo "Building opencode..."
            bun run build
          fi

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Start servers and run tests
        run: |
          bun run test/mock_llm_server.ts &
          MOCK_PID=$!
          for i in {1..30}; do
            curl -s http://localhost:4097/health > /dev/null 2>&1 && break
            sleep 1
          done
          
          export OPENCODE_CONFIG=$(pwd)/test/opencode.test.yaml
          bun run opencode/packages/opencode/src/cli/cmd/serve.ts &
          SERVER_PID=$!
          for i in {1..30}; do
            curl -s http://localhost:4096/global/health > /dev/null 2>&1 && break
            sleep 1
          done
          
          # Run existing integration tests (exclude the new ones tested separately)
          flutter test \
            integration_test/api_connection_test.dart \
            integration_test/session_lifecycle_test.dart \
            integration_test/message_send_test.dart \
            integration_test/sse_connection_test.dart \
            integration_test/permission_test.dart \
            integration_test/project_test.dart \
            integration_test/message_send_with_model_test.dart \
            integration_test/http_sse_test.dart \
            --dart-define=SERVER_URL=http://localhost:4096 || TEST_EXIT=$?
          
          kill $MOCK_PID $SERVER_PID 2>/dev/null || true
          exit ${TEST_EXIT:-0}

  # ============================================
  # Job 5a: Build APK (Parallel with tests)
  # ============================================
  build-apk:
    name: Build APK
    runs-on: ubuntu-latest
    needs: [analyze, unit-test]
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Cache Pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/.dart_tool
          key: pub-${{ hashFiles('**/pubspec.lock') }}

      - name: Get dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: opencode-mobile-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

  # ============================================
  # Job 5b: Build AAB (Parallel with tests)
  # ============================================
  build-aab:
    name: Build AAB
    runs-on: ubuntu-latest
    needs: [analyze, unit-test]
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Cache Pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/.dart_tool
          key: pub-${{ hashFiles('**/pubspec.lock') }}

      - name: Get dependencies
        run: flutter pub get

      - name: Build App Bundle
        run: flutter build appbundle --release

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: opencode-mobile-aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

  # ============================================
  # Job 6: Summary
  # ============================================
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: 
      - test-session-management
      - test-config-auth
      - test-sse-events
      - test-streaming
      - test-existing
      - build-apk
      - build-aab
    if: always()

    steps:
      - name: Report Status
        run: |
          echo "=========================================="
          echo "CI Results Summary"
          echo "=========================================="
          echo ""
          echo "Code Quality:"
          echo "  Analyze:        ✓"
          echo "  Unit Tests:     ✓"
          echo ""
          echo "Integration Tests:"
          echo "  Session Mgmt:   ${{ needs.test-session-management.result }}"
          echo "  Config & Auth:  ${{ needs.test-config-auth.result }}"
          echo "  SSE Events:     ${{ needs.test-sse-events.result }}"
          echo "  Streaming:      ${{ needs.test-streaming.result }}"
          echo "  Existing:       ${{ needs.test-existing.result }}"
          echo ""
          echo "Builds:"
          echo "  APK:            ${{ needs.build-apk.result }}"
          echo "  AAB:            ${{ needs.build-aab.result }}"
          echo "=========================================="
